<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forensic Consent Debug Dashboard — UC (via GTM) + UET + Clarity</title>

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#070b14;
      --bg2:#0b1220;
      --panel:#0f1930;
      --panel2:#0c152a;
      --text:#eef2ff;
      --muted:#b7c1e6;
      --border:#26355f;

      --good-bg: rgba(34,197,94,.18);
      --good-fg: #86efac;
      --good-bd: rgba(34,197,94,.35);

      --bad-bg: rgba(239,68,68,.18);
      --bad-fg: #fecaca;
      --bad-bd: rgba(239,68,68,.35);

      --warn-bg: rgba(245,158,11,.18);
      --warn-fg: #fde68a;
      --warn-bd: rgba(245,158,11,.35);

      --info-bg: rgba(96,165,250,.18);
      --info-fg: #bfdbfe;
      --info-bd: rgba(96,165,250,.35);
    }

    body{
      background: radial-gradient(1200px 600px at 20% 0%, #121c39 0%, var(--bg2) 55%, var(--bg) 100%);
      color: var(--text);
    }

    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .panel-inner{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
    }

    .badge-soft{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-weight: 700;
      padding: .32rem .6rem;
      border-radius: 999px;
      font-size:.8rem;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:72px;
      padding:.26rem .60rem;
      border-radius:999px;
      font-weight:800;
      font-size:.82rem;
      border:1px solid rgba(255,255,255,.16);
    }
    .pill.good{ background: var(--good-bg); color: var(--good-fg); border-color: var(--good-bd); }
    .pill.bad{  background: var(--bad-bg);  color: var(--bad-fg);  border-color: var(--bad-bd); }
    .pill.warn{ background: var(--warn-bg); color: var(--warn-fg); border-color: var(--warn-bd); }
    .pill.info{ background: var(--info-bg); color: var(--info-fg); border-color: var(--info-bd); }

    .smallcaps { letter-spacing: .08em; text-transform: uppercase; font-size: .78rem; color: var(--muted); }

    pre.logbox{
      max-height: 420px;
      overflow:auto;
      background: #050812;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 12px;
      color: #e6ecff;
      font-size: 12px;
      line-height: 1.35;
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Force Bootstrap table to be dark/transparent (fixes your "washed out" look) */
    .table{
      --bs-table-bg: transparent;
      --bs-table-color: var(--text);
      --bs-table-border-color: rgba(255,255,255,.10);
    }
    .table td, .table th { vertical-align: middle; }

    .btn-outline-light{
      border-color: rgba(255,255,255,.25);
      color: var(--text);
    }
    .btn-outline-light:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.35);
    }

    .toast-container{ position: fixed; top: 16px; right: 16px; z-index: 9999; width: min(420px, 92vw); }
  </style>

  <!-- Google Tag Manager (your container) -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5TXPGTVF');
  </script>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5TXPGTVF"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Copy JSON Modal (fallback when clipboard is blocked) -->
  <div class="modal fade" id="copyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="background: var(--panel); border:1px solid var(--border);">
        <div class="modal-header" style="border-bottom:1px solid rgba(255,255,255,.10);">
          <h5 class="modal-title">Copy JSON dump</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="muted mb-2">
            Clipboard was blocked. Use the button below or manually select + copy.
          </div>
          <button class="btn btn-outline-light btn-sm mb-2" id="btnModalCopy">Copy</button>
          <textarea id="copyArea" class="form-control mono" style="height: 52vh; background:#050812; color:#e6ecff; border:1px solid rgba(255,255,255,.12);" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
      <div>
        <h1 class="fw-bold mb-1">Forensic Consent Debug Dashboard</h1>
        <div class="muted">
          Installs <b>GTM only</b>. Usercentrics, UET and Clarity must be deployed via GTM.
          <span class="badge-soft ms-2">All code/comments in English</span>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="badge-soft">GTM: <span class="mono" id="gtmId">GTM-5TXPGTVF</span></span>
        <button class="btn btn-outline-light btn-sm" id="btnSnapshot">Snapshot</button>
        <button class="btn btn-outline-light btn-sm" id="btnDump">Dump everything</button>
        <button class="btn btn-outline-light btn-sm" id="btnCopyJson">Copy JSON</button>
        <button class="btn btn-outline-light btn-sm" id="btnClear">Clear log</button>
      </div>
    </div>

    <hr class="border-opacity-25">

    <div class="row g-3">
      <!-- High-level status -->
      <div class="col-lg-4">
        <div class="panel p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold fs-5">High-level status</div>
            <div class="smallcaps">live</div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm mb-2">
              <tbody>
                <tr>
                  <td class="muted">UC marketing consent</td>
                  <td class="text-end"><span class="pill" id="pMarketing">unknown</span></td>
                </tr>
                <tr>
                  <td class="muted">UET present</td>
                  <td class="text-end"><span class="pill" id="pUetPresent">unknown</span></td>
                </tr>
                <tr>
                  <td class="muted">UET Consent Mode (enableAdStorage)</td>
                  <td class="text-end"><span class="pill" id="pUetAd">unknown</span></td>
                </tr>

                <tr><td colspan="2" class="muted small">Clarity evidence (3 levels)</td></tr>
                <tr>
                  <td class="muted">Clarity stub present</td>
                  <td class="text-end"><span class="pill" id="pClarityStub">unknown</span></td>
                </tr>
                <tr>
                  <td class="muted">Clarity script loaded (network/perf)</td>
                  <td class="text-end"><span class="pill" id="pClarityLoaded">unknown</span></td>
                </tr>
                <tr>
                  <td class="muted">Clarity cookies present (_clck/_clsk)</td>
                  <td class="text-end"><span class="pill" id="pClarityCookies">unknown</span></td>
                </tr>
                <tr>
                  <td class="muted">Clarity “session evidence”</td>
                  <td class="text-end"><span class="pill" id="pClaritySession">unknown</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-2 muted">
            <div class="mb-2">
              <b>UET CoMo</b> is observable via <span class="mono">window.uetq.uetConfig.enableAdStorage</span> (best in-browser signal).
            </div>
            <div>
              <b>Clarity “session mode”</b> is inferred from:
              <span class="mono">(_clck/_clsk)</span> + script resource evidence. Stub alone is <i>not</i> proof.
            </div>
          </div>
        </div>
      </div>

      <!-- Quick evidence -->
      <div class="col-lg-8">
        <div class="panel p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold fs-5">Quick evidence</div>
            <div class="smallcaps">before vs after</div>
          </div>

          <div class="row g-3">
            <div class="col-md-7">
              <div class="panel-inner p-3">
                <div class="smallcaps mb-1">Last consent event</div>
                <div class="mono fs-6" id="lastEventName">—</div>

                <div class="smallcaps mt-3 mb-1">ucCategory (raw)</div>
                <pre class="logbox" style="max-height:140px" id="ucCategoryRaw">—</pre>

                <div class="smallcaps mt-3 mb-1">Service booleans (raw)</div>
                <pre class="logbox" style="max-height:160px" id="serviceRaw">—</pre>
              </div>
            </div>

            <div class="col-md-5">
              <div class="panel-inner p-3">
                <div class="smallcaps mb-1">Cookie diff since page load</div>
                <div class="mono fs-6" id="cookieDiffSummary">added=0, removed=0, changed=0</div>

                <div class="smallcaps mt-3 mb-1">UET timing</div>
                <div class="mono" id="uetTiming">—</div>

                <div class="smallcaps mt-3 mb-1">Clarity timing</div>
                <div class="mono" id="clarityTiming">—</div>

                <div class="smallcaps mt-3 mb-1">Clarity resource evidence</div>
                <div class="mono" id="clarityResourceLine">—</div>
              </div>
            </div>

            <div class="col-12">
              <div class="panel-inner p-3">
                <div class="smallcaps mb-1">Clarity session evidence</div>
                <div class="fw-bold" id="clarityEvidenceTitle">—</div>
                <div class="muted mt-2">Based on cookies + resource evidence (best possible in-browser).</div>

                <div class="row mt-3 g-2">
                  <div class="col-md-6">
                    <div class="smallcaps mb-1">Clarity cookies (visible to JS)</div>
                    <div class="mono" id="clarityCookiesList">(none)</div>
                  </div>
                  <div class="col-md-6">
                    <div class="smallcaps mb-1">UET cookies (visible to JS)</div>
                    <div class="mono" id="uetCookiesList">(none)</div>
                  </div>

                  <div class="col-12 mt-2">
                    <div class="smallcaps mb-1">Loaded script evidence</div>
                    <div class="mono" id="loadedEvidenceLine">gtm=?, uc=?, uetBat=?, clarityTag=?</div>
                    <div class="muted mt-2">
                      Tip: <b>Dump everything</b> shows full objects: <span class="mono">window.uetq</span>, <span class="mono">uetConfig</span>, <span class="mono">window.clarity</span>, resource list, and consent payloads.
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div><!-- row -->
        </div>
      </div>

      <!-- Timeline -->
      <div class="col-12">
        <div class="panel p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold fs-5">Timeline log (dataLayer, state changes, cookie diff)</div>
            <div class="smallcaps">forensics</div>
          </div>
          <pre class="logbox mono" id="log"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const START = performance.now();
      const ISO = () => new Date().toISOString();

      const state = {
        gtmId: "GTM-5TXPGTVF",
        lastConsentEvent: null,
        lastUcCategory: null,
        lastServiceBooleans: null,
        lastDataLayerPush: null,
        firstSeen: { uetq: null, uetConfig: null, clarityStub: null, clarityRuntime: null },
        cookieBaseline: null,
        cookieDiff: { added: [], removed: [], changed: [] },
        logLines: []
      };

      const $ = (id) => document.getElementById(id);
      const msSinceStart = () => Math.round(performance.now() - START);

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, (m)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }

      function toast(msg, type="info"){
        const color = type === "good" ? "rgba(34,197,94,1)" :
                      type === "bad"  ? "rgba(239,68,68,1)" :
                      type === "warn" ? "rgba(245,158,11,1)" : "rgba(96,165,250,1)";
        const el = document.createElement("div");
        el.className = "panel p-2 mb-2";
        el.style.background = "rgba(0,0,0,.35)";
        el.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <span style="width:10px;height:10px;border-radius:99px;background:${color};display:inline-block"></span>
            <div class="mono" style="font-size:12px">${escapeHtml(msg)}</div>
          </div>
        `;
        $("toastContainer").appendChild(el);
        setTimeout(()=>{ el.remove(); }, 2400);
      }

      function log(msg, obj){
        const line = `[${ISO()} | +${msSinceStart()}ms] ${msg}`;
        state.logLines.push({ t: Date.now(), line, obj: obj ?? null });
        const out = obj ? `\n${JSON.stringify(obj, null, 2)}` : "";
        $("log").textContent += ( $("log").textContent ? "\n" : "" ) + line + out;
        $("log").scrollTop = $("log").scrollHeight;
        console.log(line, obj ?? "");
      }

      function setPill(id, value){
        const node = $(id);
        node.classList.remove("good","bad","warn","info");
        if (value === true) { node.textContent = "true"; node.classList.add("good"); }
        else if (value === false) { node.textContent = "false"; node.classList.add("bad"); }
        else if (value === "partial") { node.textContent = "partial"; node.classList.add("warn"); }
        else if (value === "unknown") { node.textContent = "unknown"; node.classList.add("warn"); }
        else { node.textContent = String(value); node.classList.add("info"); }
      }

      function parseCookies(){
        const raw = document.cookie || "";
        const map = {};
        raw.split(";").map(x=>x.trim()).filter(Boolean).forEach(pair=>{
          const idx = pair.indexOf("=");
          const k = idx >= 0 ? pair.slice(0, idx) : pair;
          const v = idx >= 0 ? pair.slice(idx+1) : "";
          map[k] = v;
        });
        return map;
      }

      function cookieDiff(a, b){
        const aK = new Set(Object.keys(a||{}));
        const bK = new Set(Object.keys(b||{}));
        const added=[], removed=[], changed=[];
        for (const k of bK) if (!aK.has(k)) added.push(k);
        for (const k of aK) if (!bK.has(k)) removed.push(k);
        for (const k of bK) if (aK.has(k) && a[k] !== b[k]) changed.push(k);
        return { added, removed, changed };
      }

      function clarityStubPresent(){
        return (typeof window.clarity === "function");
      }

      function clarityRuntimeResource(){
        // IMPORTANT: Stub is not proof. Runtime evidence means an actual network resource.
        try{
          const entries = performance.getEntriesByType("resource") || [];
          const hit = entries.find(e => typeof e.name === "string" && e.name.includes("clarity.ms"));
          return hit ? hit.name : null;
        }catch{ return null; }
      }

      function uetPresent(){ return typeof window.uetq !== "undefined"; }

      function uetEnableAdStorage(){
        try{
          if (window.uetq && window.uetq.uetConfig && typeof window.uetq.uetConfig.enableAdStorage === "boolean") {
            return window.uetq.uetConfig.enableAdStorage;
          }
          return "unknown";
        }catch{ return "unknown"; }
      }

      function parseConsentStatusPush(obj){
        if (!obj || obj.event !== "consent_status") return null;
        const ucCategory = obj.ucCategory || null;
        const exclude = new Set(["event","action","type","ucCategory","gtm.uniqueEventId"]);
        const services = {};
        for (const [k,v] of Object.entries(obj)) {
          if (exclude.has(k)) continue;
          if (typeof v === "boolean") services[k] = v;
        }
        return { ucCategory, services, raw: obj };
      }

      function updateQuickEvidence(){
        $("lastEventName").textContent = state.lastConsentEvent || "—";
        $("ucCategoryRaw").textContent = state.lastUcCategory ? JSON.stringify(state.lastUcCategory, null, 2) : "—";
        $("serviceRaw").textContent = state.lastServiceBooleans ? JSON.stringify(state.lastServiceBooleans, null, 2) : "—";

        $("cookieDiffSummary").textContent =
          `added=${state.cookieDiff.added.length}, removed=${state.cookieDiff.removed.length}, changed=${state.cookieDiff.changed.length}`;

        $("uetTiming").textContent = state.firstSeen.uetConfig != null
          ? `uetConfig first seen at +${state.firstSeen.uetConfig}ms` : "—";

        $("clarityTiming").textContent = state.firstSeen.clarityStub != null
          ? `clarity() stub first seen at +${state.firstSeen.clarityStub}ms` : "—";

        $("clarityResourceLine").textContent = state.firstSeen.clarityRuntime != null
          ? `clarity runtime downloaded at ~+${state.firstSeen.clarityRuntime}ms` : "clarity runtime not detected (no resource)";
      }

      function updateEvidence(){
        const cookies = parseCookies();
        const hasClarityCookies = ("_clck" in cookies) || ("_clsk" in cookies);

        const runtime = clarityRuntimeResource();
        const runtimeLoaded = !!runtime;
        const stub = clarityStubPresent();

        // record first runtime moment
        if (runtimeLoaded && state.firstSeen.clarityRuntime == null) state.firstSeen.clarityRuntime = msSinceStart();

        // loaded script evidence
        const perf = performance.getEntriesByType("resource") || [];
        const gtmLoaded = perf.some(e => (e.name||"").includes("googletagmanager.com/gtm.js"));
        const ucLoaded  = perf.some(e => (e.name||"").toLowerCase().includes("usercentrics"));
        const uetLoaded = perf.some(e => (e.name||"").includes("bat.bing.com/bat.js"));
        $("loadedEvidenceLine").textContent = `gtm=${gtmLoaded}, uc=${ucLoaded}, uetBat=${uetLoaded}, clarityTag=${runtimeLoaded}`;

        // lists
        const clarityList = [];
        if ("_clck" in cookies) clarityList.push("_clck");
        if ("_clsk" in cookies) clarityList.push("_clsk");
        $("clarityCookiesList").textContent = clarityList.length ? clarityList.join(", ") : "(none visible to JS)";

        const uetList = [];
        ["_uetsid","_uetvid"].forEach(n => { if (n in cookies) uetList.push(n); });
        $("uetCookiesList").textContent = uetList.length ? uetList.join(", ") : "(none visible to JS)";

        // pills
        setPill("pClarityStub", stub);
        setPill("pClarityLoaded", runtimeLoaded);
        setPill("pClarityCookies", hasClarityCookies);

        // session evidence inference
        let title = "—";
        let session = "unknown";
        if (!runtimeLoaded && !hasClarityCookies) { title = "NOT LOADED — No Clarity runtime resource + no cookies. No session recording/collection on this page."; session = false; }
        else if (runtimeLoaded && !hasClarityCookies) { title = "LOADED WITHOUT COOKIES — Runtime loaded but no _clck/_clsk. No cookie-based session linking (anonymous / no stitching)."; session = "partial"; }
        else if (runtimeLoaded && hasClarityCookies) { title = "PERSISTENT LINKING ENABLED — _clck/_clsk present. Sessions can be linked across pages/visits (non-anonymous)."; session = true; }
        else { title = "INCONCLUSIVE — Signals are inconsistent. Use Network tab + Dump everything."; session = "unknown"; }

        $("clarityEvidenceTitle").textContent = title;
        setPill("pClaritySession", session);
      }

      function updateHighLevel(){
        const marketing = state.lastUcCategory?.marketing;
        setPill("pMarketing", (typeof marketing === "boolean") ? marketing : "unknown");

        setPill("pUetPresent", uetPresent() ? true : "unknown");

        const ad = uetEnableAdStorage();
        setPill("pUetAd", ad === "unknown" ? "partial" : !!ad);
      }

      function snapshot(reason){
        const cookies = parseCookies();
        const snap = {
          reason,
          marketingConsent: (typeof state.lastUcCategory?.marketing === "boolean") ? state.lastUcCategory.marketing : "unknown",
          lastConsentEvent: state.lastConsentEvent,
          lastUcCategory: state.lastUcCategory,
          lastServiceBooleans: state.lastServiceBooleans,
          uet: { present: !!window.uetq, enableAdStorage: uetEnableAdStorage() },
          clarity: { stubPresent: clarityStubPresent(), runtimeResource: clarityRuntimeResource() },
          cookies: { names: Object.keys(cookies).sort() },
          cookieDiffSinceLoad: state.cookieDiff,
          firstSeen: state.firstSeen
        };
        log(`SNAPSHOT (${reason})`, snap);
        updateAll();
      }

      function safeClone(obj){
        try{
          if (obj === null || obj === undefined) return obj;
          if (typeof obj === "function") return { __type:"function", name: obj.name || "(anonymous)" };
          if (Array.isArray(obj)) return obj.slice(0, 1000);
          if (typeof obj === "object") {
            const out = {};
            for (const k of Object.keys(obj).slice(0, 300)) {
              const v = obj[k];
              out[k] = (typeof v === "function") ? { __type:"function", name: v.name || "(anonymous)" } : v;
            }
            return out;
          }
          return obj;
        }catch(e){
          return { __error: String(e) };
        }
      }

      function dumpEverything(){
        const cookies = parseCookies();
        const resources = (performance.getEntriesByType("resource") || []).map(e => ({
          name: e.name, initiatorType: e.initiatorType,
          startTime: Math.round(e.startTime), duration: Math.round(e.duration)
        }));

        return {
          meta: {
            page: location.href,
            timestamp: new Date().toISOString(),
            gtmId: state.gtmId,
            userAgent: navigator.userAgent
          },
          consent: {
            lastConsentEvent: state.lastConsentEvent,
            lastUcCategory: state.lastUcCategory,
            lastServiceBooleans: state.lastServiceBooleans,
            lastDataLayerPush: state.lastDataLayerPush
          },
          uet: {
            uetqType: typeof window.uetq,
            uetqPresent: !!window.uetq,
            uetq: safeClone(window.uetq),
            uetConfig: safeClone(window.uetq && window.uetq.uetConfig ? window.uetq.uetConfig : null),
            enableAdStorage: uetEnableAdStorage()
          },
          clarity: {
            clarityType: typeof window.clarity,
            stubPresent: clarityStubPresent(),
            clarity: safeClone(window.clarity),
            runtimeResource: clarityRuntimeResource(),
            cookies: ["_clck","_clsk"].filter(n => n in cookies)
          },
          cookies: { all: Object.keys(cookies).sort(), map: cookies },
          cookieDiffSinceLoad: state.cookieDiff,
          firstSeen: state.firstSeen,
          performanceResources: resources,
          logLines: state.logLines
        };
      }

      async function tryClipboard(text){
        // Attempt modern Clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          try { await navigator.clipboard.writeText(text); return true; } catch {}
        }
        // Fallback: execCommand
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return ok;
        }catch{
          return false;
        }
      }

      function openCopyModal(json){
        $("copyArea").value = json;
        const modal = new bootstrap.Modal($("#copyModal"));
        modal.show();
        setTimeout(()=>{
          $("copyArea").focus();
          $("copyArea").select();
        }, 250);
      }

      function interceptDataLayer(){
        window.dataLayer = window.dataLayer || [];
        const dl = window.dataLayer;
        const originalPush = dl.push.bind(dl);

        dl.push = function(){
          for (const arg of arguments) {
            try{
              if (arg && typeof arg === "object") {
                const ev = arg.event ? String(arg.event) : "";
                log(`dataLayer.push event="${ev || "(none)"}"`, arg);
                state.lastDataLayerPush = arg;

                const parsed = parseConsentStatusPush(arg);
                if (parsed) {
                  state.lastConsentEvent = "consent_status";
                  state.lastUcCategory = parsed.ucCategory;
                  state.lastServiceBooleans = parsed.services;
                  log("UC consent_status captured", { ucCategory: parsed.ucCategory, services: parsed.services });

                  setTimeout(()=>{
                    updateAll();
                    log("Cookie diff updated after consent event", state.cookieDiff);
                  }, 250);
                }
              }
            }catch(e){
              log("Error processing dataLayer push", { error: String(e) });
            }
          }
          return originalPush.apply(null, arguments);
        };
      }

      function updateAll(){
        // cookies
        const now = parseCookies();
        if (!state.cookieBaseline) state.cookieBaseline = now;
        state.cookieDiff = cookieDiff(state.cookieBaseline, now);

        // firstSeen
        if (state.firstSeen.uetq == null && window.uetq) state.firstSeen.uetq = msSinceStart();
        if (state.firstSeen.uetConfig == null && window.uetq && window.uetq.uetConfig) state.firstSeen.uetConfig = msSinceStart();
        if (state.firstSeen.clarityStub == null && clarityStubPresent()) state.firstSeen.clarityStub = msSinceStart();

        updateEvidence();
        updateQuickEvidence();
        updateHighLevel();
      }

      // Buttons
      $("btnSnapshot").addEventListener("click", ()=> snapshot("manual"));
      $("btnDump").addEventListener("click", ()=>{
        const dump = dumpEverything();
        log("DUMP (full)", dump);
        toast("Dump logged to timeline.", "good");
      });

      $("btnCopyJson").addEventListener("click", async ()=>{
        const dump = dumpEverything();
        const json = JSON.stringify(dump, null, 2);

        const ok = await tryClipboard(json);
        if (ok) {
          toast("Copied full JSON dump to clipboard.", "good");
        } else {
          toast("Clipboard blocked. Opening modal fallback.", "warn");
          openCopyModal(json);
        }
      });

      $("btnModalCopy").addEventListener("click", async ()=>{
        const json = $("copyArea").value || "";
        const ok = await tryClipboard(json);
        if (ok) toast("Copied from modal.", "good");
        else toast("Copy still blocked. Select all and copy manually.", "bad");
      });

      $("btnClear").addEventListener("click", ()=>{
        $("log").textContent = "";
        state.logLines = [];
        toast("Log cleared.", "info");
      });

      // Init
      $("gtmId").textContent = state.gtmId;
      log("Initialized. Capturing dataLayer pushes and monitoring UET/Clarity.");
      interceptDataLayer();

      // baseline
      state.cookieBaseline = parseCookies();

      // periodic updates
      setInterval(updateAll, 750);

      // snapshots
      setTimeout(()=> snapshot("On load"), 25);
      setTimeout(()=> snapshot("T+3s"), 3000);
      setTimeout(()=> snapshot("T+10s"), 10000);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
