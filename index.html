<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forensic Consent Debug Dashboard — UC (via GTM) + UET + Clarity</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fc;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body{ background:var(--bg); color:var(--text); }
    .subtle{ color:var(--muted); }
    .card{ border:1px solid var(--border); border-radius:14px; box-shadow: 0 2px 10px rgba(17,24,39,.05); }
    .mono{ font-family: var(--mono); }
    .badge-pill{
      border-radius:999px; padding:.35rem .6rem; font-weight:700; font-size:.85rem;
      border:1px solid rgba(0,0,0,.06);
    }
    .b-ok{ background: rgba(22,163,74,.12); color: var(--ok); }
    .b-bad{ background: rgba(220,38,38,.12); color: var(--bad); }
    .b-warn{ background: rgba(245,158,11,.14); color: #92400e; }
    pre.log{
      background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px; max-height:420px; overflow:auto;
      font-family: var(--mono); font-size: 12.5px; line-height: 1.35;
    }
    pre.dump{
      background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px; overflow:auto;
      font-family: var(--mono); font-size: 12.5px; line-height: 1.35;
      max-height: 360px;
    }
    .kpi{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:.35rem 0; border-bottom:1px dashed var(--border); }
    .kpi:last-child{ border-bottom:none; }
    .section-title{ font-weight:800; }
    .soft-note{ background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; border-radius:12px; padding:10px 12px; }
    .success-note{ background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; border-radius:12px; padding:10px 12px; }
    .btn-sm{ border-radius:10px; }
  </style>
<!-- Google Consent Mode v2: HARD default (debug) -->
<script>
  // 1) Ensure dataLayer exists BEFORE GTM
  window.dataLayer = window.dataLayer || [];

  // 2) Define gtag stub that pushes into dataLayer
  function gtag(){ window.dataLayer.push(arguments); }

  // 3) Set Consent Mode DEFAULTS (GDPR-style)
  //    wait_for_update gives the CMP a short window to send "update" during the same page load.
  gtag('consent', 'default', {
    ad_storage: 'denied',
    analytics_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    wait_for_update: 2000
  });

  // Optional: reduce data leakage when denied (Google Ads)
  gtag('set', 'ads_data_redaction', true);

  // Debug marker so you can see it in console easily
  console.log('[GCM] default injected', window.dataLayer[window.dataLayer.length - 2], window.dataLayer[window.dataLayer.length - 1]);
</script>

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5TXPGTVF');
  </script>
</head>

<body>
  <!-- GTM noscript -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5TXPGTVF"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
      <div>
        <h1 class="mb-1">Forensic Consent Debug Dashboard</h1>
        <div class="subtle">
          Installs <b>GTM only</b>. Usercentrics, UET and Clarity must be deployed via GTM. All code/comments in English.
        </div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <span class="badge text-bg-light border mono">GTM: GTM-5TXPGTVF</span>
        <button class="btn btn-outline-primary btn-sm" id="btnSnapshot">Snapshot</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnDump">Dump everything</button>
        <button class="btn btn-outline-danger btn-sm" id="btnClear">Clear log</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="section-title">High-level status</div>
            <span class="badge text-bg-light border">LIVE</span>
          </div>

          <div class="mt-2">
            <div class="kpi">
              <div>UC marketing consent</div>
              <div id="k_ucMarketing" class="badge-pill b-warn">unknown</div>
            </div>

            <div class="kpi">
              <div>UET present</div>
              <div id="k_uetPresent" class="badge-pill b-warn">unknown</div>
            </div>

            <div class="kpi">
              <div>UET Consent Mode (enableAdStorage)</div>
              <div id="k_uetAdStorage" class="badge-pill b-warn">unknown</div>
            </div>

            <hr class="my-2">

            <div class="kpi">
              <div>Clarity evidence (3 levels)</div>
              <div class="subtle small">stub / runtime / cookies</div>
            </div>

            <div class="kpi">
              <div>Clarity stub present</div>
              <div id="k_clarityStub" class="badge-pill b-warn">unknown</div>
            </div>

            <div class="kpi">
              <div>Clarity runtime downloaded (perf)</div>
              <div id="k_clarityRes" class="badge-pill b-warn">unknown</div>
            </div>

            <div class="kpi">
              <div>Clarity cookies present (_clck/_clsk)</div>
              <div id="k_clarityCookies" class="badge-pill b-warn">unknown</div>
            </div>

            <div class="kpi">
              <div>Clarity “session evidence”</div>
              <div id="k_claritySession" class="badge-pill b-warn">unknown</div>
            </div>

            <hr class="my-2">

            <div class="small subtle">
              <b>UET CoMo</b> is observable via <span class="mono">window.uetq.uetConfig.enableAdStorage</span>.<br>
              <b>Clarity evidence</b>: stub ≠ proof. Runtime resource + cookies are evidence.
            </div>

            <div class="mt-3 soft-note small">
              <b>Interpretation:</b><br>
              • If Clarity runtime is downloaded <i>before</i> consent, your GTM tag loads Clarity regardless of consent.<br>
              • If cookies (<span class="mono">_clck/_clsk</span>) appear only after consent, you have strong evidence of “no session stitching before consent”.
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-3">
          <div class="section-title">Quick evidence</div>
          <div class="subtle small mb-2">Based on last <span class="mono">consent_status</span> + cookies + resource evidence.</div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="card p-3 h-100">
                <div class="subtle small">Last consent event</div>
                <div class="mono" id="q_eventName">—</div>

                <div class="mt-2 subtle small">ucCategory (raw)</div>
                <pre class="dump mb-0" id="q_ucCategory">—</pre>

                <div class="mt-2 subtle small">Service booleans (raw)</div>
                <pre class="dump mb-0" id="q_services">—</pre>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card p-3 h-100">
                <div class="subtle small">Cookie diff since page load</div>
                <div class="mono" id="q_cookieDiff">—</div>

                <div class="mt-2 subtle small">UET timing</div>
                <div class="mono" id="q_uetTiming">—</div>

                <div class="mt-2 subtle small">Clarity timing</div>
                <div class="mono" id="q_clarityTiming">—</div>

                <div class="mt-2 subtle small">Clarity runtime timing (perf)</div>
                <div class="mono" id="q_clarityResTiming">—</div>
              </div>
            </div>

            <div class="col-12">
              <div class="card p-3">
                <div class="section-title small">Clarity session evidence</div>
                <div id="q_claritySessionText" class="mono mt-1">—</div>

                <div class="row g-3 mt-2">
                  <div class="col-md-6">
                    <div class="subtle small">Clarity cookies (visible to JS)</div>
                    <div class="mono" id="q_clarityCookieList">—</div>
                  </div>
                  <div class="col-md-6">
                    <div class="subtle small">UET cookies (visible to JS)</div>
                    <div class="mono" id="q_uetCookieList">—</div>
                  </div>
                </div>

                <div class="mt-2 subtle small">Loaded script evidence</div>
                <div class="mono" id="q_loadedEvidence">—</div>

                <div class="mt-3 success-note small">
                  Tip: <b>Dump everything</b> shows full objects + perf resources + cookies + consent payload.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-3 mt-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="section-title">Timeline log</div>
            <div class="subtle small">dataLayer pushes, state changes, cookie diffs</div>
          </div>
          <pre class="log mt-2 mb-0" id="log"></pre>
        </div>

        <div class="card p-3 mt-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="section-title">Deep dumps (most detailed)</div>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-primary btn-sm" id="btnCopyDump">Copy dump JSON</button>
              <span class="subtle small" id="copyStatus"></span>
            </div>
          </div>
          <div class="subtle small mb-2">Copy includes consent payload + UET + Clarity + resources + cookies + last dataLayer pushes.</div>

          <div class="row g-3">
            <div class="col-12">
              <div class="subtle small">Dump preview (same JSON copied)</div>
              <pre class="dump" id="d_all">—</pre>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * SAFE STRINGIFY (handles circular objects + functions)
     *****************************************************************/
    function safeStringify(value, space = 2) {
      const seen = new WeakSet();
      return JSON.stringify(value, function(key, val) {
        if (typeof val === "function") return `[Function ${val.name || "anonymous"}]`;
        if (typeof val === "object" && val !== null) {
          if (seen.has(val)) return "[Circular]";
          seen.add(val);
        }
        return val;
      }, space);
    }

    /*****************************************************************
     * LOGGING
     *****************************************************************/
    const t0 = performance.now();
    const logEl = document.getElementById("log");
    function ts() {
      const now = new Date().toISOString();
      const dt = Math.round(performance.now() - t0);
      return `[${now} | +${dt}ms]`;
    }
    function log(msg, obj) {
      const line = `${ts()} ${msg}`;
      console.log(line, obj || "");
      logEl.textContent += line + (obj ? "\n" + safeStringify(obj, 2) : "") + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    /*****************************************************************
     * HELPERS: cookies, perf resources, badges
     *****************************************************************/
    function getCookieMap() {
      const out = {};
      document.cookie.split(";").map(s => s.trim()).filter(Boolean).forEach(pair => {
        const idx = pair.indexOf("=");
        const k = idx >= 0 ? pair.slice(0, idx) : pair;
        const v = idx >= 0 ? pair.slice(idx+1) : "";
        out[k] = v;
      });
      return out;
    }

    function diffCookies(a, b) {
      const added = [];
      const removed = [];
      const changed = [];
      const aKeys = new Set(Object.keys(a));
      const bKeys = new Set(Object.keys(b));
      for (const k of bKeys) if (!aKeys.has(k)) added.push(k);
      for (const k of aKeys) if (!bKeys.has(k)) removed.push(k);
      for (const k of bKeys) if (aKeys.has(k) && a[k] !== b[k]) changed.push(k);
      return { added, removed, changed };
    }

    function getPerfResources() {
      try {
        const entries = performance.getEntriesByType("resource") || [];
        return entries.map(e => ({
          name: e.name,
          initiatorType: e.initiatorType,
          startTime: Math.round(e.startTime),
          duration: Math.round(e.duration)
        }));
      } catch (e) {
        return [];
      }
    }

    function findClarityRuntime(perfList) {
      // Clarity runtime is usually https://www.clarity.ms/tag/<id> plus additional requests.
      // We treat any clarity.ms resource request as "runtime evidence".
      const hits = perfList.filter(r => (r.name || "").includes("clarity.ms"));
      if (!hits.length) return null;
      const first = hits.reduce((min, r) => r.startTime < min.startTime ? r : min, hits[0]);
      return { count: hits.length, firstStartTime: first.startTime, firstUrl: first.name, hits };
    }

    function badge(el, state) {
      el.classList.remove("b-ok","b-bad","b-warn");
      if (state === true) { el.classList.add("b-ok"); el.textContent = "true"; return; }
      if (state === false) { el.classList.add("b-bad"); el.textContent = "false"; return; }
      el.classList.add("b-warn"); el.textContent = "unknown";
    }

    /*****************************************************************
     * STATE WE TRACK
     *****************************************************************/
    let cookieBase = getCookieMap();
    let lastConsentPayload = null;     // raw consent_status object
    let lastUcCategory = null;         // payload.ucCategory
    let lastServiceFields = null;      // service booleans extracted
    let lastConsentEventName = null;

    let uetFirstSeenAt = null;
    let uetConfigFirstSeenAt = null;
    let clarityStubFirstSeenAt = null;
    let clarityRuntimeFirstSeenAt = null;

    const dlHistory = [];              // last pushes captured

    function readUetEnableAdStorage() {
      try {
        // Typical: window.uetq is array-like, uetConfig attached on it after bat.js loads
        const uetq = window.uetq || window.uetq;
        const cfg = (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig === undefined && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    (window.uetq && window.uetq.uetConfig) ? window.uetq.uetConfig :
                    null;

        // Many installs attach uetConfig to window.uetq (array)
        const enable = cfg && typeof cfg.enableAdStorage === "boolean" ? cfg.enableAdStorage : undefined;
        return { present: !!window.uetq, hasUetConfig: !!cfg, enableAdStorage: (enable === undefined ? "unknown" : enable) };
      } catch(e) {
        return { present: !!window.uetq, hasUetConfig: false, enableAdStorage: "unknown", error: String(e) };
      }
    }

    function readClarityStub() {
      return (typeof window.clarity === "function");
    }

    function computeClarityEvidence(cookieMap, perfList) {
      const hasStub = readClarityStub();

      const clarityCookies = [];
      if (cookieMap["_clck"]) clarityCookies.push("_clck");
      if (cookieMap["_clsk"]) clarityCookies.push("_clsk");

      const uetCookies = [];
      if (cookieMap["_uetsid"]) uetCookies.push("_uetsid");
      if (cookieMap["_uetvid"]) uetCookies.push("_uetvid");

      const clarityRuntime = findClarityRuntime(perfList);
      const hasRuntime = !!clarityRuntime;

      // "Session evidence" heuristic:
      // - If _clck/_clsk exist: persistent session linking is enabled (non-anonymous stitching).
      // - If no cookies but runtime exists: likely "no stitching" (or limited mode). We label it as "runtime-only".
      // - If stub only: not proof.
      let sessionText = "—";
      let sessionBool = "unknown";
      if (clarityCookies.length) {
        sessionText = "PERSISTENT LINKING ENABLED — _clck/_clsk present. Sessions can be linked across pages/visits (non-anonymous).";
        sessionBool = true;
      } else if (hasRuntime) {
        sessionText = "RUNTIME LOADED but NO _clck/_clsk — likely no cookie-based session stitching yet (best in-browser evidence).";
        sessionBool = false;
      } else if (hasStub) {
        sessionText = "ONLY STUB PRESENT — not proof of runtime execution. No cookies + no resource evidence.";
        sessionBool = false;
      } else {
        sessionText = "Clarity not detected.";
        sessionBool = false;
      }

      return {
        hasStub,
        clarityRuntime,
        hasRuntime,
        clarityCookies,
        uetCookies,
        sessionText,
        sessionBool
      };
    }

    /*****************************************************************
     * Capture dataLayer pushes (including consent_status)
     *****************************************************************/
    window.dataLayer = window.dataLayer || [];
    const originalPush = window.dataLayer.push.bind(window.dataLayer);

    window.dataLayer.push = function() {
      // GTM sometimes pushes arguments rather than a single object.
      const args = Array.from(arguments);
      let obj = args.length === 1 ? args[0] : { _args: args };

      // Attempt to detect event name
      const eventName = (obj && obj.event) ? obj.event : "(none)";
      dlHistory.push({ t: Date.now(), event: eventName, payload: obj });
      if (dlHistory.length > 25) dlHistory.shift();

      log(`dataLayer.push event="${eventName}"`, obj);

      if (eventName === "consent_status" && obj) {
        lastConsentPayload = obj;
        lastConsentEventName = "consent_status";
        lastUcCategory = obj.ucCategory || null;

        // Extract “service booleans”: keys with boolean values, excluding known non-service fields
        const ignore = new Set(["event","action","type","ucCategory","gtm.uniqueEventId"]);
        const services = {};
        Object.keys(obj).forEach(k => {
          if (ignore.has(k)) return;
          if (typeof obj[k] === "boolean") services[k] = obj[k];
        });
        lastServiceFields = services;

        log("UC consent_status captured", { ucCategory: lastUcCategory, services });
        updateUI(); // immediate refresh
        updateCookieDiff(); // after consent events, cookie behavior matters
      }

      return originalPush.apply(window.dataLayer, args);
    };

    /*****************************************************************
     * Cookie diff tracking
     *****************************************************************/
    let lastCookieDiff = { added: [], removed: [], changed: [] };
    function updateCookieDiff() {
      const now = getCookieMap();
      lastCookieDiff = diffCookies(cookieBase, now);
      log("Cookie diff updated after consent event", lastCookieDiff);
      updateUI();
    }

    /*****************************************************************
     * UI updates
     *****************************************************************/
    function updateUI() {
      const k_ucMarketing = document.getElementById("k_ucMarketing");
      const k_uetPresent = document.getElementById("k_uetPresent");
      const k_uetAdStorage = document.getElementById("k_uetAdStorage");
      const k_clarityStub = document.getElementById("k_clarityStub");
      const k_clarityRes = document.getElementById("k_clarityRes");
      const k_clarityCookies = document.getElementById("k_clarityCookies");
      const k_claritySession = document.getElementById("k_claritySession");

      // UC marketing
      let m = "unknown";
      if (lastUcCategory && typeof lastUcCategory.marketing === "boolean") m = lastUcCategory.marketing;
      badge(k_ucMarketing, m === "unknown" ? "unknown" : m);

      // UET
      const uet = readUetEnableAdStorage();
      badge(k_uetPresent, uet.present ? true : false);

      if (uet.enableAdStorage === "unknown") badge(k_uetAdStorage, "unknown");
      else badge(k_uetAdStorage, !!uet.enableAdStorage);

      // perf evidence
      const perfList = getPerfResources();
      const clarityEv = computeClarityEvidence(getCookieMap(), perfList);

      badge(k_clarityStub, clarityEv.hasStub);
      badge(k_clarityRes, clarityEv.hasRuntime);
      badge(k_clarityCookies, clarityEv.clarityCookies.length > 0);
      // Session evidence boolean
      if (clarityEv.sessionBool === "unknown") badge(k_claritySession, "unknown");
      else badge(k_claritySession, !!clarityEv.sessionBool);

      // Quick evidence
      document.getElementById("q_eventName").textContent = lastConsentEventName || "—";
      document.getElementById("q_ucCategory").textContent = lastUcCategory ? safeStringify(lastUcCategory, 2) : "—";
      document.getElementById("q_services").textContent = lastServiceFields ? safeStringify(lastServiceFields, 2) : "—";
      document.getElementById("q_cookieDiff").textContent =
        `added=${lastCookieDiff.added.length}, removed=${lastCookieDiff.removed.length}, changed=${lastCookieDiff.changed.length}`;

      document.getElementById("q_uetTiming").textContent =
        uetConfigFirstSeenAt ? `uetConfig first seen at +${uetConfigFirstSeenAt}ms` : "uetConfig not seen yet";

      document.getElementById("q_clarityTiming").textContent =
        clarityStubFirstSeenAt ? `clarity() stub first seen at +${clarityStubFirstSeenAt}ms` : "clarity() stub not seen yet";

      if (clarityEv.hasRuntime && clarityEv.clarityRuntime) {
        document.getElementById("q_clarityResTiming").textContent =
          `clarity runtime downloaded at ~+${clarityEv.clarityRuntime.firstStartTime}ms (${clarityEv.clarityRuntime.count} resource(s))`;
      } else {
        document.getElementById("q_clarityResTiming").textContent = "No clarity.ms resource entries yet";
      }

      document.getElementById("q_claritySessionText").textContent = clarityEv.sessionText;
      document.getElementById("q_clarityCookieList").textContent = clarityEv.clarityCookies.length ? clarityEv.clarityCookies.join(", ") : "(none visible to JS)";
      document.getElementById("q_uetCookieList").textContent = clarityEv.uetCookies.length ? clarityEv.uetCookies.join(", ") : "(none visible to JS)";

      const evidenceBits = [
        `gtm=${!!window.google_tag_manager || !!window.google_tag_manager}`, // weak but ok
        `uc=${detectUcGlobals().found ? "true" : "unknown"}`,
        `uetBat=${perfList.some(r => (r.name||"").includes("bat.bing.com/bat.js"))}`,
        `clarityTag=${perfList.some(r => (r.name||"").includes("clarity.ms/tag/"))}`
      ];
      document.getElementById("q_loadedEvidence").textContent = evidenceBits.join(", ");

      // Deep dump preview
      document.getElementById("d_all").textContent = safeStringify(buildDumpObject(), 2);
    }

    /*****************************************************************
     * Detect UC globals on window (best-effort)
     *****************************************************************/
    function detectUcGlobals() {
      const out = {};
      const keys = Object.keys(window);
      const candidates = keys.filter(k =>
        k.toLowerCase().includes("usercentrics") ||
        k.toLowerCase().includes("uc_") ||
        k.toLowerCase().includes("uc") && (k.toLowerCase().includes("cmp") || k.toLowerCase().includes("consent"))
      );

      // Also common known-ish keys:
      const known = ["UC_UI", "UC_UI_SUPPRESS_CMP_DISPLAY", "UC_UI_INITIALIZED", "Usercentrics", "usercentrics"];
      const merged = Array.from(new Set([...candidates, ...known])).filter(k => k in window);

      merged.slice(0, 30).forEach(k => {
        try {
          const v = window[k];
          if (typeof v === "function") out[k] = `[Function ${v.name || "anonymous"}]`;
          else if (typeof v === "object") out[k] = `[Object ${v && v.constructor ? v.constructor.name : "Object"}]`;
          else out[k] = v;
        } catch(e) {
          out[k] = `[unreadable: ${String(e)}]`;
        }
      });

      return { found: merged.length > 0, keys: merged, summary: out };
    }

    /*****************************************************************
     * Build a dump object that is safe to stringify and useful
     *****************************************************************/
    function buildDumpObject() {
      const cookies = getCookieMap();
      const perf = getPerfResources();
      const clarityEv = computeClarityEvidence(cookies, perf);
      const uet = readUetEnableAdStorage();
      const uc = detectUcGlobals();

      // Avoid dumping raw uetq if it has cycles; provide a trimmed view
      const uetSafe = {
        uetqPresent: !!window.uetq,
        uetqType: window.uetq ? Object.prototype.toString.call(window.uetq) : null,
        uetConfig: (window.uetq && window.uetq.uetConfig) ? {
          enableAdStorage: window.uetq.uetConfig.enableAdStorage,
          // include a few likely useful fields if present:
          ...pick(window.uetq.uetConfig, ["ti","tagId","uetid","isEnabled","isConsentModeEnabled","consentState"])
        } : null
      };

      // Clarity: stub is function; queue may exist at clarity.q
      const claritySafe = {
        clarityPresent: typeof window.clarity === "function",
        clarityType: typeof window.clarity,
        clarityQueueLength: (window.clarity && window.clarity.q && Array.isArray(window.clarity.q)) ? window.clarity.q.length : null
      };

      return {
        meta: {
          url: location.href,
          userAgent: navigator.userAgent,
          ts: new Date().toISOString()
        },
        consent: {
          lastConsentEventName,
          lastConsentPayload
        },
        ucCategory: lastUcCategory,
        serviceBooleans: lastServiceFields,
        uet: uetSafe,
        uetLive: uet,
        clarity: claritySafe,
        clarityEvidence: {
          stubPresent: clarityEv.hasStub,
          runtimeDownloaded: clarityEv.hasRuntime,
          runtimeFirstStartTime: clarityEv.clarityRuntime ? clarityEv.clarityRuntime.firstStartTime : null,
          runtimeFirstUrl: clarityEv.clarityRuntime ? clarityEv.clarityRuntime.firstUrl : null,
          clarityCookies: clarityEv.clarityCookies,
          uetCookies: clarityEv.uetCookies,
          sessionText: clarityEv.sessionText
        },
        cookieDiffSinceLoad: lastCookieDiff,
        cookiesVisibleToJS: Object.keys(cookies).sort(),
        cookiesRawMapSample: pick(cookies, ["_clck","_clsk","_uetsid","_uetvid"]),
        perfEvidence: {
          hasBatJs: perf.some(r => (r.name||"").includes("bat.bing.com/bat.js")),
          clarityResources: clarityEv.clarityRuntime ? clarityEv.clarityRuntime.hits : [],
          sampleFirst30: perf.slice(0, 30)
        },
        dataLayerLast25: dlHistory,
        ucGlobals: uc
      };
    }

    function pick(obj, keys) {
      const out = {};
      if (!obj) return out;
      keys.forEach(k => { if (k in obj) out[k] = obj[k]; });
      return out;
    }

    /*****************************************************************
     * Poll for UET/Clarity timings
     *****************************************************************/
    function pollSignals() {
      const now = Math.round(performance.now());

      // UET present?
      if (!uetFirstSeenAt && window.uetq) {
        uetFirstSeenAt = now;
        log("UET detected: window.uetq present");
      }
      if (!uetConfigFirstSeenAt && window.uetq && window.uetq.uetConfig) {
        uetConfigFirstSeenAt = now;
        log("UET detected: uetConfig present");
      }

      // Clarity stub present?
      if (!clarityStubFirstSeenAt && typeof window.clarity === "function") {
        clarityStubFirstSeenAt = now;
        log("Clarity detected: window.clarity stub present");
      }

      // Clarity runtime via perf?
      if (!clarityRuntimeFirstSeenAt) {
        const perf = getPerfResources();
        const hit = findClarityRuntime(perf);
        if (hit) {
          clarityRuntimeFirstSeenAt = hit.firstStartTime;
          log("Clarity runtime resource detected (clarity.ms)", { firstStartTime: hit.firstStartTime, firstUrl: hit.firstUrl, count: hit.count });
        }
      }

      updateUI();
      requestAnimationFrame(pollSignals);
    }

    /*****************************************************************
     * Buttons
     *****************************************************************/
    document.getElementById("btnClear").addEventListener("click", () => {
      logEl.textContent = "";
      log("Log cleared.");
    });

    document.getElementById("btnSnapshot").addEventListener("click", () => {
      log("SNAPSHOT (manual)", buildDumpObject());
      updateUI();
    });

    document.getElementById("btnDump").addEventListener("click", () => {
      const dump = buildDumpObject();
      log("DUMP (manual)", dump);
      updateUI();
    });

    async function copyToClipboard(text) {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
      // Fallback: hidden textarea + execCommand
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      if (!ok) throw new Error("execCommand(copy) failed");
      return true;
    }

    document.getElementById("btnCopyDump").addEventListener("click", async () => {
      const status = document.getElementById("copyStatus");
      status.textContent = "";
      try {
        const dumpObj = buildDumpObject();
        const json = safeStringify(dumpObj, 2);
        await copyToClipboard(json);
        status.textContent = "Copied ✓";
        log("Copy dump JSON: success");
      } catch (e) {
        status.textContent = "Copy failed (see console)";
        log("Copy dump JSON: failed", { error: String(e) });
      }
    });

    /*****************************************************************
     * Init
     *****************************************************************/
    log("Initialized. Capturing dataLayer pushes and monitoring UET/Clarity.");
    updateUI();

    // Snapshots at common times
    setTimeout(() => log("SNAPSHOT (T+3s)", buildDumpObject()), 3000);
    setTimeout(() => log("SNAPSHOT (T+10s)", buildDumpObject()), 10000);

    // Start polling loop
    requestAnimationFrame(pollSignals);
  </script>
</body>
</html>
